{% extends "base.html" %}

{% macro render_note(note, depth=0) %}
    <div class="note reply-note depth-{{ depth }}" id="note-{{ note.id }}">
        <div class="note-header">
            <a href="/user/{{ note.pubkey }}">
                {% if note.author_picture %}
                    <img src="{{ note.author_picture }}" class="note-avatar" alt="Avatar" loading="lazy">
                {% else %}
                    <div class="note-avatar-placeholder">
                        {{ note.pubkey[:2] }}
                    </div>
                {% endif %}
            </a>
            <div class="note-info">
                <div class="note-meta-top">
                    <a href="/user/{{ note.pubkey }}" style="text-decoration: none;">
                        <span class="note-author-name" title="{{ note.pubkey }}">
                            {% if note.author_name %}
                                {{ note.author_name }}
                            {% else %}
                                {{ note.pubkey[:8] }}...
                            {% endif %}
                        </span>
                    </a>
                    <a href="/post/{{ note.id }}" title="{{ note.timestamp }}" style="text-decoration: none; color: inherit;">
                        <span class="note-date">{{ note.created_at | time_ago }}</span>
                    </a>
                </div>
            </div>
            <button class="collapse-toggle" onclick="toggleNote('{{ note.id }}')" title="Collapse/Expand">[-]</button>
        </div>
        
        <div class="note-body" id="body-{{ note.id }}">
            <div class="note-content">
                {{ note.content | format_content | linkify_images | safe }}
            </div>

            {% if note.replies %}
                <div class="nested-replies {% if depth >= 4 %}limit-depth{% endif %}">
                    {% for reply in note.replies %}
                        {{ render_note(reply, depth + 1) }}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="collapsed-indicator" id="ind-{{ note.id }}" style="display: none;">
            <span class="collapsed-text">Thread collapsed</span>
        </div>
    </div>
{% endmacro %}

{% block content %}
    <div class="feed">
        {% if post.parent_post %}
        <div class="parent-note">
            <div class="parent-note-header">
                <span style="margin-right: 5px;">Replying to</span>
                <a href="/user/{{ post.parent_post.pubkey }}" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                    {% if post.parent_post.author_picture %}
                        <img src="{{ post.parent_post.author_picture }}" class="parent-avatar-small" alt="Avatar">
                    {% endif %}
                    <span class="parent-author-name">
                        {% if post.parent_post.author_name %}
                            {{ post.parent_post.author_name }}
                        {% else %}
                            {{ post.parent_post.pubkey[:8] }}...
                        {% endif %}
                    </span>
                </a>
            </div>
            <a href="/post/{{ post.parent_post.id }}" style="text-decoration: none; color: inherit;">
                <div class="parent-note-content">{{ post.parent_post.content | format_content | linkify_images | safe }}</div>
            </a>
        </div>
        {% endif %}

        <div class="note main-post">
            <div class="note-header">
                <a href="/user/{{ post.pubkey }}">
                    {% if post.author_picture %}
                        <img src="{{ post.author_picture }}" class="note-avatar" alt="Avatar" loading="lazy">
                    {% else %}
                        <div class="note-avatar-placeholder">
                            {{ post.pubkey[:2] }}
                        </div>
                    {% endif %}
                </a>
                <div class="note-info">
                    <a href="/user/{{ post.pubkey }}" style="text-decoration: none;">
                        <span class="note-author-name" title="{{ post.pubkey }}">
                            {% if post.author_name %}
                                {{ post.author_name }}
                            {% else %}
                                {{ note.pubkey[:8] if note else post.pubkey[:8] }}...
                            {% endif %}
                        </span>
                    </a>
                    <a href="/post/{{ post.id }}" title="{{ post.timestamp }}" style="text-decoration: none; color: inherit;">
                        <span class="note-date">{{ post.created_at | time_ago }}</span>
                    </a>
                </div>
            </div>
            <div class="note-content" style="font-size: 1.2rem; margin-bottom: 20px;">
                {{ post.content | format_content | linkify_images | safe }}
            </div>
        </div>

        <div class="reply-form" style="margin: 20px 0; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #ddd;">
            <h3>Reply to this note</h3>
            {% if not logged_in %}
                <p>Please <a href="/login">Login</a> to reply.</p>
            {% else %}
                <form action="/post/{{ post.id }}/reply" method="post">
                    <div class="form-group">
                        <textarea id="content" name="content" rows="3" required placeholder="Write your reply..." style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc;"></textarea>
                    </div>
                    <button type="submit" style="margin-top: 10px;">Send Reply</button>
                </form>
            {% endif %}
        </div>

        <div class="replies">
            <h3>Discussion</h3>
            {% if not replies %}
                <p>No replies yet.</p>
            {% endif %}
            
            {% for note in replies %}
                {{ render_note(note) }}
            {% endfor %}
        </div>
    </div>

    <script>
        function toggleNote(noteId) {
            const body = document.getElementById('body-' + noteId);
            const indicator = document.getElementById('ind-' + noteId);
            const toggle = document.querySelector('#note-' + noteId + ' .collapse-toggle');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                indicator.style.display = 'none';
                toggle.textContent = '[-]';
            } else {
                body.style.display = 'none';
                indicator.style.display = 'block';
                toggle.textContent = '[+]';
            }
        }
    </script>
{% endblock %}