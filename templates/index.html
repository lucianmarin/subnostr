{% extends "base.html" %}

{% block content %}
    <div class="feed">
        {% if not profile %}
            <h2>{{ title }}</h2>
        {% endif %}

        {% if profile %}
        <div class="profile-header">
            {% if profile.picture %}
                <img src="{{ profile.picture }}" class="profile-avatar-large" alt="Avatar">
            {% else %}
                <div class="profile-avatar-large-placeholder">{{ pubkey[:2] }}</div>
            {% endif %}
            <div class="profile-info-main">
                <div class="profile-name-row">
                    <div class="profile-name-large">{{ profile.display_name or profile.name or pubkey[:8] }}</div>
                    {% if logged_in and user_pubkey != pubkey %}
                        {% if is_following %}
                            <form action="/unfollow/{{ pubkey }}" method="post" style="display: inline;">
                                <button type="submit" class="unfollow-button">Unfollow</button>
                            </form>
                        {% else %}
                            <form action="/follow/{{ pubkey }}" method="post" style="display: inline;">
                                <button type="submit" class="follow-button">Follow</button>
                            </form>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="profile-pubkey-small">{{ pubkey }}</div>
                {% if profile.about %}
                    <div class="profile-bio">{{ profile.about }}</div>
                {% endif %}
                {% if profile.website %}
                    <div class="profile-website"><a href="{{ profile.website }}" target="_blank" rel="noopener noreferrer">{{ profile.website }}</a></div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if error %}
            <p class="error-message">{{ error }}</p>
        {% endif %}
        
        {% if not events %}
            <p>No posts found. {% if title == "Your Feed" %}Try following some people!{% endif %}</p>
        {% endif %}

        {% for note in events %}
        <div class="note">
            {% if note.parent_post %}
            <div class="parent-note">
                <div class="parent-note-header">
                    <span class="replying-to-label">Replying to</span>
                    <a href="/user/{{ note.parent_post.pubkey }}" class="parent-link">
                        {% if note.parent_post.author_picture %}
                            <img src="{{ note.parent_post.author_picture }}" class="parent-avatar-small" alt="Avatar">
                        {% endif %}
                        <span class="parent-author-name">
                            {% if note.parent_post.author_name %}
                                {{ note.parent_post.author_name }}
                            {% else %}
                                {{ note.parent_post.pubkey[:8] }}...
                            {% endif %}
                        </span>
                    </a>
                </div>
                <a href="/post/{{ note.parent_post.id }}" class="author-link">
                    <div class="parent-note-content">{{ note.parent_post.content | format_content | linkify_images | linkify_urls | safe }}</div>
                </a>
            </div>
            {% endif %}
            <div class="note-header">
                <a href="/user/{{ note.pubkey }}">
                    {% if note.author_picture %}
                        <img src="{{ note.author_picture }}" class="note-avatar" alt="Avatar" loading="lazy">
                    {% else %}
                        <div class="note-avatar-placeholder">
                            {{ note.pubkey[:2] }}
                        </div>
                    {% endif %}
                </a>
                <div class="note-info">
                    <a href="/user/{{ note.pubkey }}" class="author-link">
                        <span class="note-author-name" title="{{ note.pubkey }}">
                            {% if note.author_name %}
                                {{ note.author_name }}
                            {% else %}
                                {{ note.pubkey[:8] }}...
                            {% endif %}
                        </span>
                    </a>
                    <a href="/post/{{ note.id }}" class="note-date-link" title="{{ note.timestamp }}">
                        <span class="note-date">{{ note.created_at | time_ago }}</span>
                    </a>
                    {% if note.reply_count > 0 %}
                        <span class="reply-count">
                            ðŸ’¬ {{ note.reply_count }}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="note-content">
                {{ note.content | format_content | linkify_images | linkify_urls | safe }}
            </div>
        </div>
        {% endfor %}

        {% if next_until %}
        <div class="pagination-container">
            <a href="?until={{ next_until }}" class="load-more-button">Load More</a>
        </div>
        {% endif %}
    </div>
{% endblock %}